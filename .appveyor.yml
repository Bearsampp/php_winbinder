version: "{branch}.build.{build}"
skip_tags: true

branches:
  only:
    - main

clone_folder:  c:\projects\winbinder

image: Visual Studio 2022

install:
  ps: |
    Write-Host "Diagnosing environment variables..."
    Get-ChildItem Env: | Sort-Object Name | ForEach-Object { Write-Host $_.Name }
    
    if (-not $env:GH_PAT) {
        Write-Warning "GH_PAT environment variable is not set. Deployment will fail."
        Write-Host "CRITICAL: You MUST define 'GH_PAT' in 'Settings -> Environment -> Environment variables'."
        Write-Host "DO NOT set it in 'Settings -> Deployment' or 'Settings -> Environments' as those are different features."
        Write-Host "1. Go to Project Settings`n2. Click 'Environment' on the left`n3. Click 'Add variable' in the 'Environment variables' section`n4. Name: GH_PAT`n5. Value: <your token>`n6. Click the lock icon`n7. Click 'Save' at the bottom"
    } else {
        Write-Host "GH_PAT is detected."
    }
    echo "Build cache directory c:\build-cache"
    if (-not (Test-Path c:\build-cache)) {
            mkdir c:\build-cache
    }

    echo "Clone PHP SDK binary tools"
    if (-not (Test-Path c:\build-cache\php-sdk)) {
        git clone --quiet --depth=1 https://github.com/php/php-sdk-binary-tools.git c:\build-cache\php-sdk 2>$null
    } else {
        pushd c:\build-cache\php-sdk
        git pull --quiet 2>$null
        popd
    }

cache:
  c:\build-cache -> .appveyor.yml

build_script:
  ps: |
    .\build_all.ps1 -PhpVersion "8.4.16" -VcVersion "vs17"

deploy:
  - provider: GitHub
    auth_token: $(GH_PAT)
    artifact: /.*\.7z/
    draft: false
    prerelease: false
    force_update: true
    release: WinBinder-8.4.16
    tag: v8.4.16
    on:
      branch: main
